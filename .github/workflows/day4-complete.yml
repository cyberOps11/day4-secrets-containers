name: Day 4 - Secrets & Container Security

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  # 1. Scan de Secrets (Mode Agressif sans fichier dans le repo)
  secrets_scan:
    name: Secrets Detection (Gitleaks)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # --- ETAPE MAGIQUE : On cr√©e la config agressive temporairement ---
      - name: Create Aggressive Config
        run: |
          cat <<EOF > paranoid.toml
          title = "Mode Parano√Øaque"
          [[rules]]
          id = "generic-secret"
          description = "D√©tecte tout mot cl√© suspect (password, secret, key...)"
          # Cette regex attrape : mot-cl√© + (√©gal ou deux-points) + n'importe quelle valeur
          regex = '''(?i)(password|passwd|secret|key|token|auth|access)[_.-]*[a-z0-9]*\s*[:=]\s*.+'''
          tags = ["low", "generic"]
          EOF

      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        continue-on-error: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          # On utilise le fichier 'paranoid.toml' qu'on vient de cr√©er
          args: detect --source . --no-git --config-path ./paranoid.toml --report-path gitleaks-report.json --verbose

      - name: Upload Gitleaks Report
        uses: actions/upload-artifact@v4
        with:
          name: gitleaks-report
          path: gitleaks-report.json
          if-no-files-found: warn

  # 2. Lint Dockerfile
  dockerfile_lint:
    name: Dockerfile Security Analysis
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Hadolint - Dockerfile linter
        uses: hadolint/hadolint-action@v3.1.0
        continue-on-error: true
        with:
          dockerfile: Dockerfile.secure

  # 3. Build Image
  build_image:
    name: Build Secure Docker Image
    runs-on: ubuntu-latest
    needs: [secrets_scan, dockerfile_lint]
    steps:
      - uses: actions/checkout@v4
      - name: Build image
        run: |
          docker build -t juice-shop:latest -f Dockerfile.secure .
          docker save juice-shop:latest -o juice-shop-image.tar
      - name: Upload Image
        uses: actions/upload-artifact@v4
        with:
          name: docker-image
          path: juice-shop-image.tar
          retention-days: 1

  # 4. Scan Vuln√©rabilit√©s (Trivy)
  trivy_scan:
    name: Trivy - Container Vulnerability Scan
    runs-on: ubuntu-latest
    needs: build_image
    permissions:
      contents: read
      security-events: write
    steps:
      - uses: actions/checkout@v4
      - name: Download image
        uses: actions/download-artifact@v4
        with:
          name: docker-image
      - name: Load image
        run: docker load -i juice-shop-image.tar

      - name: Generate JSON Report
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'juice-shop:latest'
          format: 'json'
          output: 'trivy-results.json'
          severity: 'CRITICAL,HIGH'

      - name: Generate SARIF Report
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'juice-shop:latest'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Reports Artifact
        uses: actions/upload-artifact@v4
        with:
          name: security-audit-files
          path: |
            trivy-results.json
            trivy-results.sarif

      - name: Upload to Security Tab
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-results.sarif'

  # 5. R√©sum√© et Envoi (Webhook)
  summary:
    name: Security Summary & Forwarding
    runs-on: ubuntu-latest
    needs: [secrets_scan, dockerfile_lint, trivy_scan]
    if: always()
    steps:
      - name: Download Trivy Reports
        uses: actions/download-artifact@v4
        with:
          name: security-audit-files
      
      - name: Download Gitleaks Report
        uses: actions/download-artifact@v4
        with:
          name: gitleaks-report
        continue-on-error: true

      - name: Send Metrics to Prod Forwarder
        env:
          PROD_WEBHOOK_URL: ${{ secrets.PROD_WEBHOOK_URL }}
          PROD_WEBHOOK_TOKEN: ${{ secrets.PROD_WEBHOOK_TOKEN }}
        run: |
          echo "üìä Extraction des m√©triques..."
          
          # TRIVY
          if [ -f trivy-results.json ]; then
            CRITICAL_COUNT=$(jq '[.Results[] | .Vulnerabilities[]? | select(.Severity=="CRITICAL")] | length' trivy-results.json)
            HIGH_COUNT=$(jq '[.Results[] | .Vulnerabilities[]? | select(.Severity=="HIGH")] | length' trivy-results.json)
          else
            CRITICAL_COUNT=0
            HIGH_COUNT=0
          fi

          # GITLEAKS (Le vrai comptage !)
          if [ -f gitleaks-report.json ]; then
            SECRETS_COUNT=$(jq 'length' gitleaks-report.json)
            echo "üïµÔ∏è Secrets trouv√©s (Mode Agressif) : $SECRETS_COUNT"
          else
            SECRETS_COUNT=0
          fi

          CRITICAL_COUNT=${CRITICAL_COUNT:-0}
          HIGH_COUNT=${HIGH_COUNT:-0}
          SECRETS_COUNT=${SECRETS_COUNT:-0}

          STATUS="success"
          if [ "${{ needs.trivy_scan.result }}" != "success" ] || [ "$SECRETS_COUNT" -gt 0 ]; then
            STATUS="failure"
          fi

          echo "üöÄ Envoi vers $PROD_WEBHOOK_URL/github-metrics..."
          curl -X POST "$PROD_WEBHOOK_URL/github-metrics" \
          -H "Content-Type: application/json" \
          -H "X-Auth-Token: $PROD_WEBHOOK_TOKEN" \
          -d "{
            \"repository\": \"$GITHUB_REPOSITORY\",
            \"branch\": \"$GITHUB_REF_NAME\",
            \"status\": \"$STATUS\",
            \"critical\": $CRITICAL_COUNT,
            \"high\": $HIGH_COUNT,
            \"secrets\": $SECRETS_COUNT
          }"

      - name: Generate Dashboard Table
        run: |
          echo "## üõ°Ô∏è Security Analysis Dashboard" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "| :--- | :--- |" >> $GITHUB_STEP_SUMMARY
          echo "| Secrets (Paranoid) | üïµÔ∏è **$SECRETS_COUNT** |" >> $GITHUB_STEP_SUMMARY
          echo "| Monitoring Push | Envoy√© üì° |" >> $GITHUB_STEP_SUMMARY
