name: Day 4 - Secrets & Container Security

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  # 1. Scan de Secrets (ModifiÃ© pour tout dÃ©tecter)
  secrets_scan:
    name: Secrets Detection (Gitleaks)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      # On utilise l'action mais avec des arguments spÃ©cifiques pour tout scanner
      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        continue-on-error: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          # --no-git : Scanne les fichiers prÃ©sents (mÃªme vieux) et pas juste l'historique git
          # --source . : Scanne le dossier courant
          args: detect --source . --no-git --report-path gitleaks-report.json --verbose

      # IMPORTANT : On sauvegarde le rapport pour le lire dans le job "summary"
      - name: Upload Gitleaks Report
        uses: actions/upload-artifact@v4
        with:
          name: gitleaks-report
          path: gitleaks-report.json
          if-no-files-found: warn

  # 2. Lint Dockerfile
  dockerfile_lint:
    name: Dockerfile Security Analysis
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Hadolint - Dockerfile linter
        uses: hadolint/hadolint-action@v3.1.0
        continue-on-error: true
        with:
          dockerfile: Dockerfile.secure

  # 3. Build Image
  build_image:
    name: Build Secure Docker Image
    runs-on: ubuntu-latest
    needs: [secrets_scan, dockerfile_lint]
    steps:
      - uses: actions/checkout@v4
      - name: Build image
        run: |
          docker build -t juice-shop:latest -f Dockerfile.secure .
          docker save juice-shop:latest -o juice-shop-image.tar
      - name: Upload Image
        uses: actions/upload-artifact@v4
        with:
          name: docker-image
          path: juice-shop-image.tar
          retention-days: 1

  # 4. Scan VulnÃ©rabilitÃ©s (Trivy)
  trivy_scan:
    name: Trivy - Container Vulnerability Scan
    runs-on: ubuntu-latest
    needs: build_image
    permissions:
      contents: read
      security-events: write
    steps:
      - uses: actions/checkout@v4
      - name: Download image
        uses: actions/download-artifact@v4
        with:
          name: docker-image
      - name: Load image
        run: docker load -i juice-shop-image.tar

      # Rapport JSON (Vital pour le webhook)
      - name: Generate JSON Report
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'juice-shop:latest'
          format: 'json'
          output: 'trivy-results.json'
          severity: 'CRITICAL,HIGH'

      # Rapport SARIF (Pour GitHub Security)
      - name: Generate SARIF Report
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'juice-shop:latest'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Reports Artifact
        uses: actions/upload-artifact@v4
        with:
          name: security-audit-files
          path: |
            trivy-results.json
            trivy-results.sarif

      - name: Upload to Security Tab
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-results.sarif'

  # 5. RÃ©sumÃ© et Envoi vers Debian (Webhook)
  summary:
    name: Security Summary & Forwarding
    runs-on: ubuntu-latest
    needs: [secrets_scan, dockerfile_lint, trivy_scan]
    if: always()
    steps:
      # On tÃ©lÃ©charge le rapport Trivy
      - name: Download Trivy Reports
        uses: actions/download-artifact@v4
        with:
          name: security-audit-files
      
      # AJOUT : On tÃ©lÃ©charge le rapport Gitleaks (s'il existe)
      - name: Download Gitleaks Report
        uses: actions/download-artifact@v4
        with:
          name: gitleaks-report
        continue-on-error: true # Pas grave si pas de rapport (0 secrets)

      # --- Envoi des donnÃ©es vers ton infra ---
      - name: Send Metrics to Prod Forwarder
        env:
          PROD_WEBHOOK_URL: ${{ secrets.PROD_WEBHOOK_URL }}
          PROD_WEBHOOK_TOKEN: ${{ secrets.PROD_WEBHOOK_TOKEN }}
        run: |
          echo "ðŸ“Š Extraction des mÃ©triques..."
          
          # 1. COMPTAGE TRIVY (VulnÃ©rabilitÃ©s)
          if [ -f trivy-results.json ]; then
            CRITICAL_COUNT=$(jq '[.Results[] | .Vulnerabilities[]? | select(.Severity=="CRITICAL")] | length' trivy-results.json)
            HIGH_COUNT=$(jq '[.Results[] | .Vulnerabilities[]? | select(.Severity=="HIGH")] | length' trivy-results.json)
          else
            echo "âš ï¸ JSON Trivy non trouvÃ©, compteurs Ã  0."
            CRITICAL_COUNT=0
            HIGH_COUNT=0
          fi

          # 2. COMPTAGE GITLEAKS (Secrets) - C'est ici qu'on rÃ©cupÃ¨re le chiffre pour l'alerte !
          if [ -f gitleaks-report.json ]; then
            SECRETS_COUNT=$(jq 'length' gitleaks-report.json)
            echo "ðŸ•µï¸ Secrets trouvÃ©s : $SECRETS_COUNT"
          else
            echo "âœ… Aucun rapport Gitleaks (0 secrets)."
            SECRETS_COUNT=0
          fi

          # Valeurs par dÃ©faut si vide
          CRITICAL_COUNT=${CRITICAL_COUNT:-0}
          HIGH_COUNT=${HIGH_COUNT:-0}
          SECRETS_COUNT=${SECRETS_COUNT:-0}

          STATUS="success"
          if [ "${{ needs.trivy_scan.result }}" != "success" ] || [ "$SECRETS_COUNT" -gt 0 ]; then
            STATUS="failure"
          fi

          echo "ðŸš€ Envoi vers $PROD_WEBHOOK_URL/github-metrics..."
          
          # Envoi avec le champ "secrets" rempli
          curl -X POST "$PROD_WEBHOOK_URL/github-metrics" \
          -H "Content-Type: application/json" \
          -H "X-Auth-Token: $PROD_WEBHOOK_TOKEN" \
          -d "{
            \"repository\": \"$GITHUB_REPOSITORY\",
            \"branch\": \"$GITHUB_REF_NAME\",
            \"status\": \"$STATUS\",
            \"critical\": $CRITICAL_COUNT,
            \"high\": $HIGH_COUNT,
            \"secrets\": $SECRETS_COUNT
          }"

      - name: Generate Dashboard Table
        run: |
          echo "## ðŸ›¡ï¸ Security Analysis Dashboard" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "| :--- | :--- |" >> $GITHUB_STEP_SUMMARY
          echo "| Status | ${{ needs.trivy_scan.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Monitoring Push | EnvoyÃ© ðŸ“¡ |" >> $GITHUB_STEP_SUMMARY
